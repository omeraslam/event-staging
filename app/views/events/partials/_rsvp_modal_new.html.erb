<!--upgrade modal-->
<div id="rsvp-new-modal" class="remodal">

<div class="modal-secure"><i class="fa fa-lock"> </i> </div>

<%= form_tag complete_registration_path, :id => 'purchase-tickets_form' do |f|  %>

					<% if @purchase.errors.any? %>
			<div class="alert error">
			    <h2><%= pluralize(@purchase.errors.count, "error") %> prohibited this event from being saved:</h2>

			      <ul>
			        <% @purchase.errors.full_messages.each do |message| %>
			        <li><%= message %></li>
			        <% end %>
			      </ul>
			</div>
			<% end %>








		<div class="modal-header modal-header-light">
	    <h3> <%= @event.name %> </h3>	 
      <p> <%= @event.date_start.to_date.strftime("%B %d ")%>  | 
        <% if @current_ticket.price == 0 %>   
          Free 
        <% else %>
          <span class="form-price"><%= number_to_currency(@current_ticket.price) %></span>
        <% end %>   
      </p>

     <%= hidden_field_tag 'ticket_id['+@current_ticket.id.to_s+']', @current_ticket.id %>
		


	    				<p><span class="form-quantity">1</span> X 
	    					<% if @current_ticket.price == 0 %>
			              	Free
				          <% else %>
				              <span class="form-price"><%= number_to_currency(@current_ticket.price) %></span>
				          <% end %> 
			          
                    <% if @has_paid_ticket %>(+ 2.5% + $.99)<% end %> </p> 
                    <% if @has_paid_ticket %>  <p><strong>Total:</strong><span class="form-total"> $<%= number_with_precision(@starter_price, :precision => 2) %> </span></p> <% end %>
    		    </div>
			   <div>
			</div>

    
		
		<div class="modal-body">
  

		

    <%# @RICH  -   if MORE THAN 1 TICKET EXISTS  %>
     <% if (@tickets.count > 1) %>
            <div class="input-group ticket-type">
                <label>Select Ticket:</label>
             
                <%= select("ticket", "title", @tickets.collect {|p| [ p.title + ' ($' + number_with_precision(p.price.to_s, :precision => 2) + ')' , p.id ] }) %>

            </div>
    <% end %>
    <%# END  %>



	    	<div class="input-group quantity">
		    		<label>Select Quantity:</label>
			           <% if LineItem.where(:ticket_id => @current_ticket.id.to_s).count < (@current_ticket.ticket_limit.to_i-@current_ticket.buy_limit.to_i) %>
			              <%= select_tag "ticket_quantity["+@current_ticket.id.to_s+']', options_for_select((1..@current_ticket.buy_limit).step(1)) %>
			          <% else %>

			              <%= select_tag "ticket_quantity["+@current_ticket.id.to_s+']', options_for_select((1..(@current_ticket.ticket_limit.to_i-LineItem.where(:ticket_id => @current_ticket.id.to_s).count)).step(1)) %>
			          <% end %>
			</div>





<%= hidden_field_tag :user_id, @user.id  %>
<%= hidden_field_tag :event_id, @event.id  %>


      <div class="input-group"> 
        <div class="input-group-inline">
          <label> First Name </label>
          <input type="text" class="input " name="purchase[first_name]" placeholder="First Name"/> 
        </div>

        <div class="input-group-inline">
          <label> Last Name </label>
          <input type="text" class="input " name="purchase[last_name]"  placeholder="Last Name" /> 
        </div>
      </div>

      <div class="input-group"> 
          <label> Email Address </label>
          <input type="text" class="input" name="purchase[email]" placeholder="email@email.com" /> 
  

  <!--       <div class="input-group-inline">
          <label> Phone Number (optional) </label>
          <input type="text" name="purchase[phone_number]" placeholder="(555) 555-5555"  /> 
        </div> -->
      </div>      

      <% if @has_paid_ticket %>



          <div class="input-group">
            <label>Credit card number</label>
            <input  type="text" id="cc" placeholder="&#9679;&#9679;&#9679;&#9679;&#9679; &#9679;&#9679;&#9679;&#9679;&#9679; &#9679;&#9679;&#9679;&#9679;&#9679; &#9679;&#9679;&#9679;&#9679;&#9679;" class="input cc-number" >
         
            
          </div>
          
          <div class="input-group">
            <div class="input-group-inline">   
              <label>Expiration (month/year)</label>
              <input placeholder="12 / 2018" class="input cc-exp" type="text" > 
            </div>
            <div class="input-group-inline" id="cvv"> 
              <label>CVV</label>
              <input class="input cc-cvc" type="text" placeholder="CVV" maxlength="4"  >
            </div>
          </div>  


      <% end %>


	
      <div class="input-group"> 
	       		<% if !@has_paid_ticket %>

			    	<button class="btn btn-large">Register Now</button>
			    <% else %>
			    	<button class="btn btn-large">Buy Tickets</button>
				<% end %>

        <p class="input-secure"><i class="fa fa-lock"> </i> Secure server </p>

      <p>
        Your privacy is very important to us. By using this website, registering for an event and/or making a purchase, you agree to EventCreate's <a href="www.eventcreate.com/terms" target="_blank">Terms of Service </a> and <a href="www.eventcreate.com/privacy" target="_blank"> Privacy Policy</a>. All ticketing sales are final and non-refundable. 

      </p>

      </div>

      














  </div>  
    

</div>

<% if @has_paid_ticket %>
<script type="text/javascript" src="/assets/ticket-payment-modal.js"></script>
<% end %>


<script type="text/javascript">
  
$(document).ready(function() {

  $('#purchase-tickets_form .ticket-type select').on('change', function(){
    var priceStringFromTitle = $('#ticket_title option:selected').text();
    var filteredPrice = priceStringFromTitle.substring( priceStringFromTitle.lastIndexOf("$")+1, 
                                priceStringFromTitle.lastIndexOf( ")" ) 
                              );

    $('.form-price').text('$' + filteredPrice);
    var total_price = (($('.form-quantity').text()* filteredPrice)*.025)+($('.form-quantity').text()*filteredPrice)+(.99*$('.form-quantity').text())
    $('.form-total').text(' $'+ (Math.round((total_price + 0.00001) * 100) / 100));


  });


  //rsvp dropdown
  $('#purchase-tickets_form .quantity select').on('change', function(){

 var priceStringFromTitle = $('#ticket_title option:selected').text();
    var filteredPrice = priceStringFromTitle.substring( priceStringFromTitle.lastIndexOf("$")+1, 
                                priceStringFromTitle.lastIndexOf( ")" ) 
                              );
    $('.form-price').text('$' + filteredPrice);
    $('.form-quantity').text($(this).val());
    var total_price = (($(this).val()* filteredPrice)*.025)+($(this).val()*filteredPrice)+(.99*$(this).val())
    $('.form-total').text(' $'+ (Math.round((total_price + 0.00001) * 100) / 100));
  });

  $(".toggle-container").click(function() {   
      $(this).toggleClass("toggle-on");
      $(this).find("span").text("live");
  });




  //TICKET - new ticket modal functionality and validation
  $("#show-event-description").click(function() {  
    $(this).hide();
    $("#ticket-description").slideDown();
  });
  $("#show-ticket-advanced-settings").click(function() {  
    $("#ticket-advanced-settings").slideToggle();
  });
  var validator = $("#new_ticket").validate({
    rules: {
      name: "required",
      "ticket[title]": {
        required: true
      }
    }, messages : {
      "ticket[title]": 'Please enter a ticket name.'
    }
  });


  

    var validator = $("#purchase-tickets_form").validate({
    rules: {
      "purchase[first_name]": {
        required: true
      },
      "purchase[last_name]": {
        required: true
      },
      "purchase[email]": {
        required: true
      },
      "purchase[email]": {
        required: true
      }
    }, messages : {
      "purchase[first_name]": 'Please enter your first name.',
      "purchase[last_name]": 'Please enter your last name.',
      "purchase[email]": 'Please enter a valid email.',

    }
  });

  var attendee_length = $('.ticket-holder').length;
  for(var i=0; i< attendee_length; i++ ) {

  $("input[name='attendees["+ (i+1) +"][first_name]']").rules("add", {required: true, messages: { required: 'Please enter a valid first name'}});
  
  $("input[name='attendees["+ (i+1) +"][last_name]']").rules("add", {required: true, messages: { required: 'Please enter a valid last name'}});
  

  $("input[name='attendees["+ (i+1) +"][email]']").rules("add", {required: true, messages: { required: 'Please enter a valid email'}});
  }



  var attendee_length = $('.ticket-holder').length;
  for(var i=0; i< attendee_length; i++ ) {

  $("input[name='attendees["+ (i+1) +"][first_name]']").rules("add", {required: true, messages: { required: 'Please enter a valid first name'}});
  
  $("input[name='attendees["+ (i+1) +"][last_name]']").rules("add", {required: true, messages: { required: 'Please enter a valid last name'}});
  

  $("input[name='attendees["+ (i+1) +"][email]']").rules("add", {required: true, messages: { required: 'Please enter a valid email'}});
  }

});

</script>







	   
	
					
	
		 
		 
		</div> 

			<% end %>
		
</div>
<!-- END modal -->

